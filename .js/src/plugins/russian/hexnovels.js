var e=this&&this.__assign||function(){return e=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e},e.apply(this,arguments)},t=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(a,l){function i(e){try{o(r.next(e))}catch(e){l(e)}}function u(e){try{o(r.throw(e))}catch(e){l(e)}}function o(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,u)}o((r=r.apply(e,t||[])).next())}))},n=this&&this.__generator||function(e,t){var n,r,a,l={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]},i=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return i.next=u(0),i.throw=u(1),i.return=u(2),"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(u){return function(o){return function(u){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,u[0]&&(l=0)),l;)try{if(n=1,r&&(a=2&u[0]?r.return:u[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,u[1])).done)return a;switch(r=0,a&&(u=[2&u[0],a.value]),u[0]){case 0:case 1:a=u;break;case 4:return l.label++,{value:u[1],done:!1};case 5:l.label++,r=u[1],u=[0];continue;case 7:u=l.ops.pop(),l.trys.pop();continue;default:if(!(a=l.trys,(a=a.length>0&&a[a.length-1])||6!==u[0]&&2!==u[0])){l=0;continue}if(3===u[0]&&(!a||u[1]>a[0]&&u[1]<a[3])){l.label=u[1];break}if(6===u[0]&&l.label<a[1]){l.label=a[1],a=u;break}if(a&&l.label<a[2]){l.label=a[2],l.ops.push(u);break}a[2]&&l.ops.pop(),l.trys.pop();continue}u=t.call(e,l)}catch(e){u=[6,e],r=0}finally{n=a=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,o])}}},r=this&&this.__spreadArray||function(e,t,n){if(n||2===arguments.length)for(var r,a=0,l=t.length;a<l;a++)!r&&a in t||(r||(r=Array.prototype.slice.call(t,0,a)),r[a]=t[a]);return e.concat(r||Array.prototype.slice.call(t))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var l=require("@libs/defaultCover"),i=require("@libs/filterInputs"),u=require("@libs/fetch"),o=require("@libs/novelStatus"),c=require("@libs/proseMirrorToHtml"),s=require("cheerio"),v=a(require("dayjs")),f={ONGOING:o.NovelStatus.Ongoing,INPROGRESS:o.NovelStatus.Ongoing,DONE:o.NovelStatus.Completed,COMPLETED:o.NovelStatus.Completed,HIATUS:o.NovelStatus.OnHiatus,PAUSED:o.NovelStatus.OnHiatus,FROZEN:o.NovelStatus.OnHiatus,ANNOUNCE:o.NovelStatus.Unknown,CANCELLED:o.NovelStatus.Cancelled,DROPPED:o.NovelStatus.Cancelled},h=[{label:"Просмотры",value:"viewsCount"},{label:"Лайки",value:"likesCount"},{label:"Количество глав",value:"chaptersCount"},{label:"Закладки",value:"bookmarksCount"},{label:"Рейтинг",value:"averageRating"},{label:"Дата добавления",value:"createdAt"}],p=[{label:"По убыванию",value:"desc"},{label:"По возрастанию",value:"asc"}],d=[{label:"Россия",value:"RUSSIA"},{label:"Япония",value:"JAPAN"},{label:"Корея",value:"KOREA"},{label:"Китай",value:"CHINA"},{label:"Другое",value:"OTHER"}],b=[{label:"Онгоинг",value:"ONGOING"},{label:"Завершено",value:"DONE"},{label:"Заморожено",value:"FROZEN"},{label:"Анонс",value:"ANNOUNCE"}],m=[{label:"Безопасный",value:"SAFE"},{label:"Небезопасный",value:"UNSAFE"},{label:"Эротика",value:"EROTIC"},{label:"Порнография",value:"PORNOGRAPHIC"}],g=[{label:"Ёнкома",value:"FOURTH_KOMA"},{label:"Сборник",value:"COMPILATION"},{label:"Додзинси",value:"DOUJINSHI"},{label:"Вебтун",value:"WEBTOON"},{label:"Цветное",value:"COLORED"},{label:"Артбук",value:"ARTBOOK"},{label:"Сингл",value:"SINGLE"},{label:"Ранобэ",value:"LIGHT"},{label:"Веб-новелла",value:"WEB"}],y=[{label:"Арт",value:"art"},{label:"Боевик",value:"action"},{label:"Боевые искусства",value:"martial_arts"},{label:"Вампиры",value:"vampires"},{label:"Гарем",value:"harem"},{label:"Гендерная интрига",value:"gender_intriga"},{label:"Детектив",value:"detective"},{label:"Дзёсэй",value:"josei"},{label:"Драма",value:"drama"},{label:"Игра",value:"game"},{label:"Исекай",value:"isekai"},{label:"История",value:"historical"},{label:"Киберпанк",value:"cyberpunk"},{label:"Кодомо",value:"codomo"},{label:"Комедия",value:"comedy"},{label:"Махо-сёдзё",value:"maho_shoujo"},{label:"Меха",value:"mecha"},{label:"Мистика",value:"mystery"},{label:"Научная фантастика",value:"sci_fi"},{label:"Омегаверс",value:"omegavers"},{label:"Повседневность",value:"natural"},{label:"Постапокалиптика",value:"postapocalypse"},{label:"Приключения",value:"adventure"},{label:"Психология",value:"psychological"},{label:"Романтика",value:"romance"},{label:"Самурай",value:"samurai"},{label:"Сверхъестественное",value:"supernatural"},{label:"Сёдзё",value:"shoujo"},{label:"Сёнэн",value:"shounen"},{label:"Спорт",value:"sports"},{label:"Сэйнэн",value:"seinen"},{label:"Трагедия",value:"tragedy"},{label:"Триллер",value:"thriller"},{label:"Ужасы",value:"horror"},{label:"Фантастика",value:"fantastic"},{label:"Фэнтези",value:"fantasy"},{label:"Школа",value:"school"},{label:"Эротика",value:"erotica"},{label:"Этти",value:"ecchi"}],w=function(){function e(){this.id="hexnovels",this.name="HexNovels",this.icon="src/ru/hexnovels/icon.png",this.site="https://hexnovels.me",this.api="https://api.hexnovels.me",this.version="1.0.12",this.filters={sortField:{label:"Поле сортировки",value:"viewsCount",options:h,type:i.FilterTypes.Picker},sortOrder:{label:"Порядок сортировки",value:"desc",options:p,type:i.FilterTypes.Picker},countries:{label:"Страны",value:[],options:d,type:i.FilterTypes.CheckboxGroup},statuses:{label:"Статус произведения",value:[],options:b,type:i.FilterTypes.CheckboxGroup},contentStatuses:{label:"Статус контента",value:[],options:m,type:i.FilterTypes.CheckboxGroup},formats:{label:"Форматы",value:[],options:g,type:i.FilterTypes.CheckboxGroup},genres:{label:"Жанры",value:{include:[],exclude:[]},options:y,type:i.FilterTypes.ExcludableCheckboxGroup},strictLabelEqual:{label:"Строгое совпадение включённых жанров",value:!1,type:i.FilterTypes.Switch},averageRatingMin:{label:"Рейтинг от",value:"",type:i.FilterTypes.TextInput},averageRatingMax:{label:"Рейтинг до",value:"",type:i.FilterTypes.TextInput},chaptersCountMin:{label:"Глав от",value:"",type:i.FilterTypes.TextInput},chaptersCountMax:{label:"Глав до",value:"",type:i.FilterTypes.TextInput},yearMin:{label:"Год от",value:"",type:i.FilterTypes.TextInput},yearMax:{label:"Год до",value:"",type:i.FilterTypes.TextInput}}}return e.prototype.popularNovels=function(e,r){return t(this,arguments,void 0,(function(e,t){var r,a,l,i,u=t.showLatestNovels,o=t.filters;return n(this,(function(t){return r=u?"updatedAt":(null===(l=null==o?void 0:o.sortField)||void 0===l?void 0:l.value)||"viewsCount",a=u?"desc":(null===(i=null==o?void 0:o.sortOrder)||void 0===i?void 0:i.value)||"desc",[2,this.fetchCatalogBooks(e,r,a,"",o)]}))}))},e.prototype.parseNovel=function(e){return t(this,void 0,void 0,(function(){var t,a,i,c,h,p,d,b,m,g,y,w,O,j,M,T,U,R,F,L,_,B,H,P,G,D,q,K,W,J;return n(this,(function(n){switch(n.label){case 0:return t=A(this.site,e),[4,(0,u.fetchApi)(t)];case 1:if(!(a=n.sent()).ok)throw new Error("Could not reach ".concat(t," (").concat(a.status,")"));return[4,a.text()];case 2:return i=n.sent(),c=(0,s.load)(i),h=z(c),p=h?Z(h,"current-book"):null,d=h?Z(h,"current-book-chapters"):null,b=c("h1").first().text().trim(),m=null===(q=c('meta[property="og:title"]').attr("content"))||void 0===q?void 0:q.trim(),$=c("title").text(),g=$.replace(/\s+[—-]\s+HexNovels$/i,"").trim(),y=null===(K=c('meta[name="description"]').attr("content"))||void 0===K?void 0:K.trim(),w=null===(W=c('meta[property="og:image"]').attr("content"))||void 0===W?void 0:W.trim(),O={path:e,name:b||m||g||"",summary:y,cover:w||l.defaultCover},p&&((j=N(p.name))&&(O.name=j),(M=N(p.description))&&(O.summary=M),(null===(J=p.poster)||void 0===J?void 0:J.trim())&&(O.cover=p.poster.trim()),(T=function(e){if("string"!=typeof e||0===e.trim().length)return;return f[e.toUpperCase()]||o.NovelStatus.Unknown}(p.status))&&(O.status=T),U=function(e){var t;if(!(null==e?void 0:e.length))return;var n=e.find((function(e){return"AUTHOR"===e.type})),r=null===(t=null==n?void 0:n.publisher)||void 0===t?void 0:t.name;if("string"==typeof r&&r.trim().length>0)return r.trim();return}(p.relations),U&&(O.author=U),(R=function(e){if(!(null==e?void 0:e.length))return;var t=e.map((function(e){return"string"==typeof(null==e?void 0:e.name)?e.name.trim():""})).filter((function(e){return e.length>0}));if(!t.length)return;return t.join(", ")}(p.labels))&&(O.genres=R),void 0!==(F=function(e){if("number"!=typeof e||!Number.isFinite(e))return;return e>5?e/2:e}(p.averageRating))&&(O.rating=F)),L=function(e){var t=e.split("?")[0].replace(/\/+$/,""),n=t.match(/\/content\/([^/]+)/);if(null==n?void 0:n[1])return n[1];return""}(e)||(null==p?void 0:p.slug)||"",(_=I(null==p?void 0:p.id))||!L?[3,4]:[4,E(this.api,L)];case 3:_=n.sent(),n.label=4;case 4:return(B=d||[]).length||!_?[3,6]:[4,k(this.api,_)];case 5:B=n.sent(),n.label=6;case 6:return B.length?_?[4,S(this.api,_)]:[3,8]:[3,10];case 7:return P=n.sent(),[3,9];case 8:P=new Map,n.label=9;case 9:H=P,G=r([],B,!0).sort(C),D=[],G.forEach((function(t,n){var r,a=null===(r=t.id)||void 0===r?void 0:r.trim();if(a){var l=function(e,t){var n=I(e);if(!n)return;return t.get(n)||"Branch ".concat(n.slice(0,8))}(t.branchId,H);D.push({name:x(t,n+1),path:L?"/content/".concat(L,"/").concat(a):"".concat(e.replace(/\/+$/,""),"/").concat(a),releaseTime:t.createdAt?(0,v.default)(t.createdAt).format("LLL"):void 0,chapterNumber:n+1,scanlator:l,page:l})}})),O.chapters=D,n.label=10;case 10:return[2,O]}var $}))}))},e.prototype.parseChapter=function(e){return t(this,void 0,void 0,(function(){var t,r,a,l,i,o,v,f,h,p,d,b,m,g,y,w,N,O;return n(this,(function(n){switch(n.label){case 0:return t=A(this.site,e),[4,(0,u.fetchApi)(t)];case 1:if(!(r=n.sent()).ok)throw new Error("Could not reach ".concat(t," (").concat(r.status,")"));return[4,r.text()];case 2:return a=n.sent(),l=(0,s.load)(a),i=z(l),o=i?Z(i,"reader-current-chapter"):null,v=i?Z(i,"secret-key"):null,f=i?Z(i,"current-rich-attachments"):null,h=function(e){var t=e.split("?")[0].replace(/\/+$/,""),n=t.split("/").filter(Boolean),r=n[n.length-1];if(!r||(a=r,!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(a)))return null;var a;return r}(e),(null==o?void 0:o.content)?"string"==typeof o.content&&o.content.trim().length>0?[2,U(o.content,this.api,h,f,v)]:"object"!=typeof o.content?[3,4]:(p=function(e){var t=new Set;return T(e,t),Array.from(t)}(o.content),[4,R(this.api,h,f,p)]):[3,4];case 3:if(d=n.sent(),b=(0,c.proseMirrorToHtml)(o.content,{resolveImageUrls:function(e){return function(e,t,n){if(!t||!e.attrs)return;var r=J(e.attrs);if(!r.length)return;var a=r.map((function(e){return G($(t[e]),n,e)})).filter((function(e){return Boolean(e)}));if(!a.length)return;return a}(e,d,v)}}),b.trim().length>0)return[2,U(b,this.api,h,f,v,d)];n.label=4;case 4:if(null==(m=a.match(/window\["current-chapter"\]\s*=\s*(\{[\s\S]*?\});?\s*<\/script>/))?void 0:m[1])try{if(g=JSON.parse(m[1]),null===(O=g.content)||void 0===O?void 0:O.trim())return[2,U(g.content,this.api,h,f,v)]}catch(e){}for(y=0,w=[".chapter-content",".reader-content",".prose",'[class*="content"]',"article","main"];y<w.length;y++)if((N=l(w[y]).first().html())&&N.length>100)return[2,U(N,this.api,h,f,v)];return[2,""]}}))}))},e.prototype.fetchImage=function(e){return t(this,void 0,void 0,(function(){var t,r;return n(this,(function(n){switch(n.label){case 0:return t=function(e){var t,n,r,a=e.trim();if(!a)return null;try{var l=JSON.parse(a),i=null===(t=l.imageUrl)||void 0===t?void 0:t.trim(),u=null===(n=l.secretKey)||void 0===n?void 0:n.trim();return i&&u?{imageUrl:i,secretKey:u,cacheKey:(null===(r=l.cacheKey)||void 0===r?void 0:r.trim())||i}:null}catch(e){return null}}(e),t?[4,q(t.imageUrl,t.secretKey)]:[2,null];case 1:return(r=n.sent())?[2,r.dataUrl]:[2,null]}}))}))},e.prototype.searchNovels=function(e,r){return t(this,void 0,void 0,(function(){return n(this,(function(t){return[2,this.fetchCatalogBooks(r,"viewsCount","desc",e,void 0)]}))}))},e.prototype.fetchCatalogBooks=function(e,r,a,i,o){return t(this,void 0,void 0,(function(){var t,c,s,v,f,h,p,d,b,m,g,y,w,A,O,x,C,E;return n(this,(function(n){switch(n.label){case 0:return t=function(e,t,n,r){var a=new URLSearchParams;a.set("size","30"),a.set("page","".concat(Math.max(e-1,0))),a.set("sort","".concat(t,",").concat(n));var l=r.trim();l.length>0&&a.set("search",l);return a}(e,r,a,i),j(t,"country",null===(v=null==o?void 0:o.countries)||void 0===v?void 0:v.value),j(t,"status",null===(f=null==o?void 0:o.statuses)||void 0===f?void 0:f.value),j(t,"contentStatus",null===(h=null==o?void 0:o.contentStatuses)||void 0===h?void 0:h.value),j(t,"formats",null===(p=null==o?void 0:o.formats)||void 0===p?void 0:p.value),j(t,"labelsInclude",null===(b=null===(d=null==o?void 0:o.genres)||void 0===d?void 0:d.value)||void 0===b?void 0:b.include),j(t,"labelsExclude",null===(g=null===(m=null==o?void 0:o.genres)||void 0===m?void 0:m.value)||void 0===g?void 0:g.exclude),(null===(y=null==o?void 0:o.strictLabelEqual)||void 0===y?void 0:y.value)&&t.set("strictLabelEqual","true"),M(t,"averageRatingMin",null===(w=null==o?void 0:o.averageRatingMin)||void 0===w?void 0:w.value),M(t,"averageRatingMax",null===(A=null==o?void 0:o.averageRatingMax)||void 0===A?void 0:A.value),M(t,"chaptersCountMin",null===(O=null==o?void 0:o.chaptersCountMin)||void 0===O?void 0:O.value),M(t,"chaptersCountMax",null===(x=null==o?void 0:o.chaptersCountMax)||void 0===x?void 0:x.value),M(t,"yearMin",null===(C=null==o?void 0:o.yearMin)||void 0===C?void 0:C.value),M(t,"yearMax",null===(E=null==o?void 0:o.yearMax)||void 0===E?void 0:E.value),c="".concat(this.api,"/v2/books?").concat(t.toString()),[4,(0,u.fetchApi)(c)];case 1:if(!(s=n.sent()).ok)throw new Error("Could not reach ".concat(c," (").concat(s.status,")"));return[4,s.json()];case 2:return[2,n.sent().filter((function(e){return"string"==typeof e.slug&&e.slug.trim().length>0})).map((function(e){return{name:N(e.name)||e.slug||"Unknown",path:"/content/".concat(e.slug),cover:"string"==typeof e.poster&&e.poster.trim().length>0?e.poster.trim():l.defaultCover}}))]}}))}))},e}();function A(e,t){try{return new URL(t,e).href}catch(r){var n=t.startsWith("/")?t:"/".concat(t);return"".concat(e).concat(n)}}function N(e){if("string"==typeof e&&e.trim().length>0)return e.trim();if(e&&"object"==typeof e)for(var t=e,n=0,r=["ru","en","original","name"];n<r.length;n++){var a=t[r[n]];if("string"==typeof a&&a.trim().length>0)return a.trim()}}function O(e){var t=Number(e);return Number.isFinite(t)?t:0}function x(e,t){var n=O(e.number),r=O(e.volume),a="string"==typeof e.name?e.name.trim():"",l=[];return r>0&&l.push("Том ".concat(r)),n>0&&l.push("Глава ".concat(n)),a.length>0&&l.push(a),l.length>0?l.join(" - "):"Глава ".concat(t)}function C(e,t){var n=O(e.volume)-O(t.volume);if(0!==n)return n;var r=O(e.number)-O(t.number);if(0!==r)return r;var a=function(e,t){if(!e||!t)return 0;var n=Date.parse(e),r=Date.parse(t);if(!Number.isFinite(n)||!Number.isFinite(r))return 0;return n-r}(e.createdAt,t.createdAt);return 0!==a?a:0}function E(e,r){return t(this,void 0,void 0,(function(){var t,a,l,i;return n(this,(function(n){switch(n.label){case 0:if(!(t=r.trim()))return[2,null];a="".concat(e,"/v2/books/").concat(encodeURIComponent(t)),n.label=1;case 1:return n.trys.push([1,4,,5]),[4,(0,u.fetchApi)(a)];case 2:return(l=n.sent()).ok?[4,l.json()]:[2,null];case 3:return[2,I(null==(i=n.sent())?void 0:i.id)];case 4:return n.sent(),[2,null];case 5:return[2]}}))}))}function k(e,r){return t(this,void 0,void 0,(function(){var t,a,l,i;return n(this,(function(n){switch(n.label){case 0:if(!(t=I(r)))return[2,[]];a="".concat(e,"/v2/chapters?bookId=").concat(encodeURIComponent(t)),n.label=1;case 1:return n.trys.push([1,4,,5]),[4,(0,u.fetchApi)(a)];case 2:return(l=n.sent()).ok?[4,l.json()]:[2,[]];case 3:return i=n.sent(),[2,Array.isArray(i)?i:[]];case 4:return n.sent(),[2,[]];case 5:return[2]}}))}))}function S(e,r){return t(this,void 0,void 0,(function(){var t,a,l,i,o;return n(this,(function(n){switch(n.label){case 0:if(!(t=I(r)))return[2,new Map];a="".concat(e,"/v2/branches?bookId=").concat(encodeURIComponent(t)),n.label=1;case 1:return n.trys.push([1,4,,5]),[4,(0,u.fetchApi)(a)];case 2:return(l=n.sent()).ok?[4,l.json()]:[2,new Map];case 3:return i=n.sent(),Array.isArray(i)?(o=new Map,i.forEach((function(e){var t=I(e.id);if(t){var n=function(e){var t=(e.publishers||[]).map((function(e){var t;return(null===(t=null==e?void 0:e.name)||void 0===t?void 0:t.trim())||""})).filter((function(e){return e.length>0})),n=Array.from(new Set(t));if(n.length>0)return n.join(" / ");var r=I(e.id);return r?"Branch ".concat(r.slice(0,8)):null}(e);n&&o.set(t,n)}})),[2,o]):[2,new Map];case 4:return n.sent(),[2,new Map];case 5:return[2]}}))}))}function I(e){var t=null==e?void 0:e.trim();return t&&t.length>0?t:null}function j(e,t,n){(null==n?void 0:n.length)&&n.map((function(e){return e.trim()})).filter((function(e){return e.length>0})).forEach((function(n){return e.append(t,n)}))}function M(e,t,n){if(n){var r=n.trim();/^-?\d+$/.test(r)&&e.set(t,r)}}function T(e,t){if(Array.isArray(e))e.forEach((function(e){return T(e,t)}));else if(e&&"object"==typeof e){var n=e,r=n.attrs;r&&"object"==typeof r&&!Array.isArray(r)&&J(r).forEach((function(e){return t.add(e)})),T(n.content,t)}}function U(e,r,a,l,i,u){return t(this,void 0,void 0,(function(){var t,o;return n(this,(function(n){switch(n.label){case 0:return e&&/blob:/i.test(e)?(t=function(e){var t=e.match(/<img\b[^>]*\bsrc=["']blob:/gi);return(null==t?void 0:t.length)||0}(e),[4,F(r,a,u||l)]):[2,e];case 1:return(o=n.sent())?[2,W(e,o,i,t)]:[2,e]}}))}))}function R(e,r,a,l){return t(this,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return l.length&&(l.filter((function(e){return!$(null==a?void 0:a[e])})).length&&r)?[4,_(e,r)]:[2,a];case 1:return t=n.sent(),[2,B(a,t)]}}))}))}function F(e,r,a){return t(this,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return L(a).length>0?[2,a]:r?[4,_(e,r)]:[2,a];case 1:return t=n.sent(),[2,B(a,t)]}}))}))}function L(e,t){if(!e)return[];var n=Object.entries(e).filter((function(e){var t=e[1];return Boolean($(t))})).map((function(e){return e[0]}));return"number"==typeof t&&t>0?n.slice(0,t):n}function _(e,r){return t(this,void 0,void 0,(function(){var t,a,l,i;return n(this,(function(n){switch(n.label){case 0:t="".concat(e,"/v2/rich-attachments?chapterId=").concat(encodeURIComponent(r)),n.label=1;case 1:return n.trys.push([1,4,,5]),[4,(0,u.fetchApi)(t)];case 2:return(a=n.sent()).ok?[4,a.json()]:[2,null];case 3:return l=n.sent(),Array.isArray(l)&&l.length?(i={},l.forEach((function(e){var t,n,r=null===(t=e.id)||void 0===t?void 0:t.trim(),a=null===(n=e.image)||void 0===n?void 0:n.trim();r&&a&&(i[r]={id:r,image:a})})),[2,Object.keys(i).length>0?i:null]):[2,null];case 4:return n.sent(),[2,null];case 5:return[2]}}))}))}function B(t,n){return t||n?e(e({},n||{}),t||{}):null}exports.default=new w;var H=new Map,P=120;function G(e,t,n){var r=null==e?void 0:e.trim();if(r){if(!D(r))return r;var a=null==t?void 0:t.trim();if(!a)return r;var l={imageUrl:r,secretKey:a,cacheKey:(null==n?void 0:n.trim())||r},i=JSON.stringify(l);return"novelimg://hexnovels?ref=".concat(encodeURIComponent(i))}}function D(e){var t,n=((null===(t=e.split("/").pop())||void 0===t?void 0:t.split("?")[0])||"").split(".")[0]||"";if(36!==n.length)return null;var r=n[14];return"x"===r?"xor":"s"===r?"sec":null}function q(e,r,a){return t(this,void 0,void 0,(function(){var t,l,i,o,c,s,v,f,h,p,d,b,m,g;return n(this,(function(n){switch(n.label){case 0:if(!(t=D(e)))return[2,null];if(!(l=null==r?void 0:r.trim()))return[2,null];if(i="".concat(l,"::").concat(e),o=function(e){var t=H.get(e);if(!t)return null;return H.delete(e),H.set(e,t),t}(i),o)return"number"==typeof a&&o.decodedBytes>a?[2,null]:[2,o];c="sec"===t?function(e){var t=e.indexOf("?"),n=t>=0?e.slice(0,t):e,r=t>=0?e.slice(t):"",a=n.split("/"),l=a.pop()||"",i=l.lastIndexOf("."),u=i>=0?l.slice(0,i):l,o=i>=0?l.slice(i):"";if(36!==u.length)return e;var c="".concat(u.slice(0,14),"x").concat(u.slice(15)).concat(o);return a.push(c),"".concat(a.join("/")).concat(r)}(e):e,n.label=1;case 1:return n.trys.push([1,4,,5]),[4,(0,u.fetchApi)(c)];case 2:return(s=n.sent()).ok?(v=s.headers.get("content-length"),"number"==typeof a&&v&&(f=Number(v),Number.isFinite(f)&&f>a)?[2,null]:(p=Uint8Array.bind,[4,s.arrayBuffer()])):[2,null];case 3:return h=new(p.apply(Uint8Array,[void 0,n.sent()])),"number"==typeof a&&h.length>a?[2,null]:(d=function(e,t){var n=function(e){for(var t=e.length,n=new Uint8Array(t),r=0;r<t;r+=1)n[r]=255&e.charCodeAt(r);return n}(t);if(!n.length)return e;for(var r=new Uint8Array(e.length),a=0;a<e.length;a+=1)r[a]=e[a]^n[a%n.length];return r}(h,l),b=function(e,t){if(e.length>8&&137===e[0]&&80===e[1]&&78===e[2]&&71===e[3])return"image/png";if(e.length>3&&255===e[0]&&216===e[1])return"image/jpeg";if(e.length>12&&82===e[0]&&73===e[1]&&70===e[2]&&70===e[3]&&87===e[8]&&69===e[9]&&66===e[10]&&80===e[11])return"image/webp";if(e.length>4&&71===e[0]&&73===e[1]&&70===e[2])return"image/gif";var n=t.toLowerCase();if(n.endsWith(".png"))return"image/png";if(n.endsWith(".webp"))return"image/webp";if(n.endsWith(".gif"))return"image/gif";if(n.endsWith(".jpg")||n.endsWith(".jpeg"))return"image/jpeg";return"application/octet-stream"}(d,e),m=function(e){for(var t="",n=0;n<e.length;n+=3){var r=e[n]<<16|(n+1<e.length?e[n+1]:0)<<8|(n+2<e.length?e[n+2]:0);t+=K[r>>18&63],t+=K[r>>12&63],t+=n+1<e.length?K[r>>6&63]:"=",t+=n+2<e.length?K[63&r]:"="}return t}(d),g={dataUrl:"data:".concat(b,";base64,").concat(m),decodedBytes:d.length},function(e,t){H.has(e)&&H.delete(e);H.set(e,t);for(;H.size>P;){var n=H.keys().next().value;if(!n)return;H.delete(n)}}(i,g),[2,g]);case 4:return n.sent(),[2,null];case 5:return[2]}}))}))}var K="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function W(e,t,n,r){if(!e||!/blob:/i.test(e))return e;var a=function(e,t,n){if(!e)return[];var r=Object.entries(e).map((function(e){var n=e[0];return G($(e[1]),t,n)})).filter((function(e){return Boolean(e)}));return"number"==typeof n&&n>0?r.slice(0,n):r}(t,n,r);if(!a.length)return e;var l='<div id="hexnovels-content-root">'.concat(e,"</div>"),i=(0,s.load)(l),u=0;return i("#hexnovels-content-root img").each((function(e,t){var n,r=null===(n=i(t).attr("src"))||void 0===n?void 0:n.trim().toLowerCase();if(null==r?void 0:r.startsWith("blob:")){var l=a[u];l?(u+=1,i(t).attr("src",l)):i(t).remove()}})),i("#hexnovels-content-root").html()||e}function J(e){var t=[],n=function(e){if("string"==typeof e){var n=e.trim();n.length>0&&t.push(n)}};return n(e.image),n(e.id),Array.isArray(e.images)&&e.images.forEach(n),Array.from(new Set(t))}function $(e){if("string"==typeof e){var t=e.trim();return t.length>0?t:void 0}if(e&&"object"==typeof e){var n=e.image;if("string"==typeof n){var r=n.trim();return r.length>0?r:void 0}}}function z(e){var t=e("#it-astro-state").html();if(!t)return null;try{var n=JSON.parse(t);if(Array.isArray(n))return n}catch(e){return null}return null}function Z(e,t){var n=e.findIndex((function(e){return e===t}));if(-1===n||n+1>=e.length)return null;var r=new Map,a=new Set;return Q(e,e[n+1],r,a)}function Q(e,t,n,r){if("number"==typeof t&&Number.isInteger(t)&&t>=0&&t<e.length){if(n.has(t))return n.get(t);if(r.has(t))return null;r.add(t);var a=e[t],l=void 0;if(Array.isArray(a))l=a.map((function(t){return Q(e,t,n,r)}));else if(a&&"object"==typeof a){var i={};Object.entries(a).forEach((function(t){var a=t[0],l=t[1];i[a]=Q(e,l,n,r)})),l=i}else l=a;return r.delete(t),n.set(t,l),l}if(Array.isArray(t))return t.map((function(t){return Q(e,t,n,r)}));if(t&&"object"==typeof t){var u={};return Object.entries(t).forEach((function(t){var a=t[0],l=t[1];u[a]=Q(e,l,n,r)})),u}return t}